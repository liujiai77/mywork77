<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>XX电商·运营后台·订单录入与销售看板</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .box { border:1px solid #ddd; padding:10px; margin:10px 0; }
        .clock { font-size: 20px; font-weight:bold; color: #336699; }
        label { display:inline-block; width:120px; }
        table { border-collapse: collapse; width:100%; margin-top:10px; }
        th, td { border:1px solid #ccc; padding:4px 8px; text-align:center; }
        .tip-banner { padding:12px; margin:10px 0; border-left:5px solid; }
        .tip-banner--discount { background:#fffbe6; border-color:#f4d06f; }
        .tip-banner--normal { background:#f5f5f5; border-color:#ccc; }
        .tip-banner--policy { background:#eef9ff; border-color:#3aa0e6; }
    </style>
</head>
<body>
    <!-- 页面标题与温馨提示 -->
    <h1>XX电商·运营后台·订单录入与销售看板</h1>
    <p>欢迎使用内部工具，实时查看订单与销售情况。</p>
    
    <div class="tip-banner tip-banner--policy">
        <strong>温馨提示：本店当前可享受的优惠与加价政策如下：</strong>
        <ul style="margin:8px 0 0 20px; line-height:1.6;">
            <li>VIP 客户享受<strong>9 折优惠</strong></li>
            <li>加急发货价格会<strong>×1.1</strong></li>
            <li>每小时前10分钟再享 <strong>8.5 折</strong></li>
            <li>前10分钟+数量≥5件，额外享受<strong>8折</strong>叠加优惠</li>
        </ul>
    </div>

    <!-- 模拟时钟 -->
    <div class="clock" id="clock"></div>
    
    <!-- 实时时段折扣提示 -->
    <div id="timeDiscountTip" class="tip-banner"></div>

    <!-- 订单录入表单 -->
    <div class="box">
        <h3>新建订单</h3>
        <form onsubmit="return validateForm()">
            <p>
                <label>客户名称：</label>
                <input type="text" id="customerName" placeholder="请输入客户名称" required>
            </p>
            <p>
                <label>商品单价（¥）：</label>
                <input type="number" id="priceInput" placeholder="请输入大于0的数字" min="0.01" step="0.01" required>
            </p>
            <p>
                <label>数量（件）：</label>
                <input type="number" id="qtyInput" placeholder="请输入大于0的整数" min="1" step="1" required>
            </p>
            <p>
                <label>客户类型：</label>
                <select id="customerType">
                    <option value="normal">普通客户</option>
                    <option value="vip">VIP客户</option>
                </select>
            </p>
            <p>
                <label>加急发货：</label>
                <input type="checkbox" id="urgentFlag"> 是
            </p>
            <p>
                <button type="submit">添加订单</button>
            </p>
        </form>
    </div>

    <!-- 订单结果展示 -->
    <div id="orderResult" class="box"></div>

    <!-- 销售看板与历史订单 -->
    <div class="box">
        <h3>销售看板</h3>
        <div id="dashboard"></div>
        <h3>历史订单</h3>
        <div id="orderTable"></div>
    </div>

    <script>
        // 存储所有订单的数组
        var orders = [];

        // 补零函数
        function padZero(n) {
            return n < 10 ? "0" + n : n;
        }

        // 更新时钟函数
        function updateClock() {
            var now = new Date();
            var y = now.getFullYear();
            var m = now.getMonth() + 1;
            var d = now.getDate();
            var hh = now.getHours();
            var mm = now.getMinutes();
            var ss = now.getSeconds();
            var weekNames = ["日", "一", "二", "三", "四", "五", "六"];
            var w = weekNames[now.getDay()];
            var timeStr = y + "年" + padZero(m) + "月" + padZero(d) + "日 星期" + w + " " + padZero(hh) + ":" + padZero(mm) + ":" + padZero(ss);
            document.getElementById("clock").innerHTML = timeStr;
            
            // 同步更新时段折扣提示
            updateTimeDiscountTip();
        }

        // 更新时段折扣提示
        function updateTimeDiscountTip() {
            var now = new Date();
            var minute = now.getMinutes();
            var tipEl = document.getElementById("timeDiscountTip");
            
            if (minute >= 0 && minute <= 9) {
                tipEl.className = "tip-banner tip-banner--discount";
                tipEl.innerHTML = "当前为前 10 分钟！本单可额外享受<strong>8.5 折</strong>时段优惠！";
            } else {
                tipEl.className = "tip-banner tip-banner--normal";
                tipEl.innerHTML = "小贴士：每个整点前10分钟享受 8.5 折优惠，请留意下单时间~";
            }
        }

        // 初始化时钟并每秒更新
        updateClock();
        setInterval(updateClock, 1000);

        // 表单验证
        function validateForm() {
            var nameStr = document.getElementById("customerName").value.trim();
            var price = parseFloat(document.getElementById("priceInput").value);
            var qty = parseInt(document.getElementById("qtyInput").value, 10);
            var typeStr = document.getElementById("customerType").value;
            var urgentChecked = document.getElementById("urgentFlag").checked;
            var valid = true;
            var errorMsg = "";

            // 客户名称校验
            if (!nameStr) {
                errorMsg = "客户名称不能为空！";
                valid = false;
            }
            // 商品单价校验
            else if (isNaN(price) || price <= 0) {
                errorMsg = "商品单价必须是大于0的数字！";
                valid = false;
            }
            // 数量校验
            else if (isNaN(qty) || qty <= 0 || !Number.isInteger(qty)) {
                errorMsg = "数量必须是大于0的整数！";
                valid = false;
            }

            // 验证失败处理
            if (!valid) {
                alert(errorMsg);
                document.getElementById("orderResult").innerHTML = `<p style="color: red;">订单录入失败：${errorMsg}</p>`;
                return false;
            }

            // 验证通过，处理订单
            processOrder(nameStr, price, qty, typeStr === "vip", urgentChecked);
            
            // 重置表单
            document.querySelector("form").reset();
            
            return false;
        }

        // 订单处理（含折扣计算）
        function processOrder(customerName, price, quantity, isVip, isUrgent) {
            // 1. 基础金额：单价 × 数量
            var baseTotal = price * quantity;
            // 2. VIP折扣：9折（普通客户无）
            var afterVip = isVip ? baseTotal * 0.9 : baseTotal;
            // 3. 加急加价：×1.1（不加急无）
            var afterUrgent = isUrgent ? afterVip * 1.1 : afterVip;
            // 4. 时段折扣：前10分钟8.5折
            var now = new Date();
            var minute = now.getMinutes();
            var hitTimeDiscount = minute >= 0 && minute <= 9;
            var finalTotal = afterUrgent;

            // 应用时段折扣
            if (hitTimeDiscount) {
                finalTotal *= 0.85;
            }

            // 特殊逻辑：前10分钟 + 数量≥5件 → 额外8折
            var hitExtraDiscount = hitTimeDiscount && quantity >= 5;
            if (hitExtraDiscount) {
                finalTotal *= 0.8;
            }

            // 订单重要性判断
            var isImportant = isVip && finalTotal > 1000;

            // 拼接优惠详情
            var tipsHtml = "<ul>";
            tipsHtml += isVip ? "<li>VIP 9折已应用</li>" : "<li>普通客户无VIP优惠</li>";
            tipsHtml += isUrgent ? "<li>加急 ×1.1 已应用</li>" : "<li>未加急</li>";
            tipsHtml += hitTimeDiscount ? "<li>命中前10分钟 ×0.85</li>" : "<li>无时段折扣</li>";
            tipsHtml += hitExtraDiscount ? "<li>满足前10分钟+数量≥5件，额外 ×0.8</li>" : "";
            tipsHtml += "</ul>";

            // 展示订单结果
            document.getElementById("orderResult").innerHTML = `
                <h3 style="color: green;">订单录入成功：</h3>
                <p>客户名称：${customerName}</p>
                <p>基础金额：¥${baseTotal.toFixed(2)}</p>
                <p>VIP后：¥${afterVip.toFixed(2)}</p>
                <p>加急后：¥${afterUrgent.toFixed(2)}</p>
                <p>最终金额：¥${finalTotal.toFixed(2)}</p>
                <p>订单类型：${isImportant ? "大额VIP" : "普通订单"}</p>
                <div style='background:#eef; padding:8px; '>优惠详情：${tipsHtml}</div>
            `;

            // 存储订单到数组（统一保留2位小数）
            orders.push({
                name: customerName,
                price: parseFloat(price.toFixed(2)),
                qty: quantity,
                baseTotal: parseFloat(baseTotal.toFixed(2)),
                finalTotal: parseFloat(finalTotal.toFixed(2)),
                isVip: isVip,
                isUrgent: isUrgent,
                hitTimeDiscount: hitTimeDiscount
            });

            // 更新销售看板和历史订单
            renderDashboard();
        }

        // 销售看板与历史订单渲染
        function renderDashboard() {
            var count = orders.length;
            var totalSales = orders.reduce((sum, order) => sum + order.finalTotal, 0);
            // 计算平均客单价
            var avg = count > 0 ? totalSales / count : 0;

            // 渲染看板数据
            document.getElementById("dashboard").innerHTML = `
                <p>订单数：${count}</p>
                <p>销售总额：¥${totalSales.toFixed(2)}</p>
                <p>平均客单价：¥${avg.toFixed(2)}</p>
            `;

            // 渲染历史订单表格
            var tableHtml = `
                <table>
                    <tr>
                        <th>客户名称</th>
                        <th>单价</th>
                        <th>数量</th>
                        <th>基础金额</th>
                        <th>最终金额</th>
                        <th>VIP</th>
                        <th>加急</th>
                        <th>时段折扣</th>
                    </tr>
            `;
            
            if (count === 0) {
                tableHtml += `<tr><td colspan="8">暂无订单数据</td></tr>`;
            } else {
                orders.forEach(o => {
                    tableHtml += `
                        <tr>
                            <td>${o.name}</td>
                            <td>¥${o.price.toFixed(2)}</td>
                            <td>${o.qty}</td>
                            <td>¥${o.baseTotal.toFixed(2)}</td>
                            <td>¥${o.finalTotal.toFixed(2)}</td>
                            <td>${o.isVip ? "是" : "否"}</td>
                            <td>${o.isUrgent ? "是" : "否"}</td>
                            <td>${o.hitTimeDiscount ? "是" : "否"}</td>
                        </tr>
                    `;
                });
            }
            
            tableHtml += "</table>";
            document.getElementById("orderTable").innerHTML = tableHtml;
        }

        // 初始化销售看板（无订单时显示默认数据）
        renderDashboard();
    </script>
</body>
</html>